---
title: "Conjoint Analysis Team Project"
#output: html_document
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
date: "2025-06-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Purpose and product

The following is a conjoint analysis for a breakfast product to be sold in Tokyo, mainly targeting office professionals.

## Defining the attributes

The research will include six attributes. Conventional attributes:

-   Price
-   Form
-   Purchase Location

Innovative attributes:

-   Fun Packaging
-   Cognitive Support
-   Digital Integration

Loading the data and creating the attribute:

```{r}
# load required libraries

library(conjoint)
library(dplyr)
library(purrr)
library(readxl)
library(usethis)
library(ggplot2)
library(knitr)
library(googlesheets4)
library(forcats)
library(tidyr)
library(gridExtra)
library(tidytext)
library(tidyr)
library(wordcloud)
library(reshape2)
library(syuzhet)
library(wordcloud)
library(topicmodels)
library(utf8)
library(readxl)
library(textdata)
library(lubridate)
library(plotly)
library(GGally)
library(factoextra)
library(cluster)

# source custom functions from sensei
source("SCRIPTS/conjoint_tool_new.R")
source("SCRIPTS/cltool_new.R")


# define the attributes
attribute <- list(
  Price = c("200", "400", "600"),
  Form = c("Bread and Pastries","Onigiri","Protein sticks"),
  PurchaseLocation = c("On Route to work","Within 150m", "More than 150m"),
  FunPackaging = c("None", "Attack on Titan", "Doan Ritsu"),
  CognitiveSupport = c("None","Caffeine or Alertness boost",
                       "Natural Mood Stabilizer"),
  DigitalIntegration = c("None", "Loyalty points", "Nutrition Advice")
)

kable(data.frame(attribute))
```

## Generating products for survey

To generate the combinations for the survey, we run:

```{r}
# Step 2: Profile Construction
# Full factorial design
profiles <- expand.grid(attribute)

# Orthogonal design
design.o <- caFactorialDesign(data=profiles, type="fractional", cards=13)
# Assigning incremental id for clarity
design.o.p <- tibble::rowid_to_column(design.o, "ID")
# Assigning variable for part-worth calculation
brkfst_design <- design.o

# Displaying table
kable(design.o.p)
```

## Data loading and sanitization

Proceeding with loading the data from the survey:

```{r}

## reading the survey data
#Read google sheets data into R
brkfst <- read_excel("DATA/DDM_MCU_survey.xlsx", 
                            sheet = "Form Responses 1")
```

Before starting the analysis, we sanitize the data. Given that country input was free-hand with no pre-built validation, we take a look at the values collected:

```{r}

# check country
brkfst %>% 
  group_by(country) %>% 
  summarize(n = n())

```

We proceed to santize the `country` variable, and roll-up into a `region` variable:

```{r}

# sanitize county
brkfst <- 
  brkfst %>% 
  mutate(country2 = case_when(country == "TW" ~ "Taiwan",
                              country == "singapore" ~ "Singapore",
                              country == "PHILIPPINES" ~ "Philippines",
                              TRUE ~ country))

# check country
brkfst %>% 
  group_by(country2) %>% 
  summarize(n = n())


# create region
brkfst <- brkfst %>%
  mutate(region = case_when(
    country2 %in% c("Taiwan", "China", "Japan", "Korea", 
                   "Mongolia", "South Korea") ~ "East Asia",
    country2 %in% c("Singapore", "Malaysia", "Thailand", "Vietnam",
                   "Myanmar", "Philippines" ) ~ "South-East Asia",
    country2 %in% c("India", "Bangladesh") ~ "Indian subcontinent",
    country2 %in% c("Bulgaria", "Romania", "Slovakia",
                   "United States") ~ "Western",
                              TRUE ~ country))
# check region
brkfst %>% 
  group_by(region) %>% 
  summarize(n = n())
```

We further roll-up some variables, with low number of observations in some levels that are similar to others.

```{r}
# roll up working starting time
brkfst %>% 
  group_by(work_start) %>% 
  summarize(n = n())

brkfst <- brkfst %>% 
  mutate(work_start_cut = 
           case_when(
             work_start %in% c("Before 07:00", "07:00~08:00", "08:00~09:00") ~ "Before 9:00",
             work_start %in% c("09:00~10:00", "After 10:00") ~ "After 9:00"
         ))


brkfst %>% 
  group_by(work_start_cut) %>% 
  summarize(n = n())


# roll up exercise per week
brkfst <- brkfst %>% 
  mutate(exercise_per_week_cut = 
           case_when(
             exercise_per_week %in% c("< 1") ~ "Never",
             exercise_per_week %in% c("1-3", "4-5") ~ "1-5 times"
           ))

brkfst %>% 
  group_by(exercise_per_week_cut) %>% 
  summarize(n = n())

```


## Generating partworth utilities

Next step is to generate part worth utilies, based on responents preference for the product combinations.

```{r}

# ratings cut
brkfst_rating <- 
  brkfst %>% 
  select(starts_with("PROD"))

# generating partworths
brkfst_part <- ca.part.util(brkfst_rating ,brkfst_design, attribute)

```

Before visualizing, we need to combine the partworth estimations with the initial data:
```{r}

## Combine parthworth-demographics -----
### combine parth worth utilities with main data frame
brkfst_cmb <- 
  cbind(brkfst, brkfst_part) %>% 
  ### deal with duplicated 'none' column
  rename(L_10_None = 39,
         L_13_None = 42,
         L_16_None = 45,
  )

### rename with long ordered columns
brkfst_cmb <- 
  brkfst_cmb %>% 
  rename(L_1_200 = 30 ,
         L_2_400 = 31,
         L_3_600 = 32, 
         `L_4_Bread and Pastries` = 33,
         L_5_Onigiri = 34,
         `L_6_Protein sticks` = 35,
         `L_7_On Route to work` = 36,
         `L_8_Within 150m` = 37,
         `L_9_More than 150m` = 38,
         L_10_None = 39,
         `L_11_Attack on Titan` = 40 ,
         `L_12_Doan Ritsu` = 41,
         `L_13_None`= 42,
         `L_14_Caffeine or Alertness boost` = 43,
         `L_15_Natural Mood Stabilizer` = 44,
         L_16_None = 45 ,
         `L_17_Loyalty points` = 46,
         `L_18_Nutrition Advice` = 47
  )

```


To get the parthworth utilies for all the sample, We compute the column means and plot the result. These values are also used for trade-off analysis:

```{r}
#overall average utilities
average_utility <- colMeans(brkfst_part)
average_utility_df <- data.frame(level = names(average_utility),
           avg_utility = average_utility)

average_utility_df <- 
  average_utility_df %>% 
  filter(level != "intercept")

average_utility_df <- 
  average_utility_df %>% 
  mutate(group =
           c("Price", "Price", "Price",
             "Form", "Form", "Form",
             "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
             "FunPackaging", "FunPackaging", "FunPackaging",
             "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
             "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>% 
  mutate(level_fct = factor(level)) %>% 
  mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
  mutate(order_rnk = level, rank) %>% 
  mutate(space_char = rep(c("L"), length(average_utility_df$level))) %>% 
  unite("lng_level", c("space_char","rank","level"))
  
average_utility_df <- average_utility_df %>% 
  mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
  mutate(lng_level = as.factor(lng_level)) %>% 
  mutate(lng_level = fct_reorder(lng_level, rank )) %>% 
  mutate(group_fct = factor(group, levels = c("Price", "Form", "PurchaseLocation",
                            "FunPackaging", "CognitiveSupport", "DigitalIntegration"
                            )))

kable(average_utility_df %>% 
        select(lng_level, avg_utility, group),
      col.names = c("Level", "Utility", "Attribute"))

# kable(brkfst_desc_slice,
#       col.names = c("Observations", "Level","Utility", "Attribute"))

```

Visualizing the partworth utilities for all the sample is done with the following code. 
```{r}

ggplot(average_utility_df, aes(x=lng_level, y = avg_utility
                               ,fill = group_fct
))+
  geom_col() +
  coord_flip() + 
  scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
  geom_text(aes(label = format(round(avg_utility, 2), nsmall = 2)), vjust = -0.5) +
  ggtitle(paste("All sample", length(brkfst$nickname), sep = ", n=")) +
  guides(fill="none")
```



To evaluate relative ordinal preference, we can sort descending by utility:
```{r, fig.width=16, fig.height=14}

## all sample parthworth utilities - sorted descending
plot_list <- list()
n_obs = length(brkfst_cmb$nickname)
iter = "All sample"

  brkfst_desc_slice <-  brkfst_cmb %>% 
    mutate(item_col = iter) %>% 
    group_by(item_col) %>% 
    summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
                 mean , na.rm = TRUE) %>% 
    pivot_longer(-item_col) %>% 
    mutate(group_aggr =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>%
    mutate(group_aggr = 
             factor(group_aggr, levels = c("Price", "Form", "PurchaseLocation",
                                           "FunPackaging", "CognitiveSupport", "DigitalIntegration"
             ))) %>% 
    arrange(desc(value)) %>% 
    ungroup
  
# kable(brkfst_desc_slice,
#       col.names = c("Observations", "Level","Utility", "Attribute"))
    ggplot(brkfst_desc_slice, 
                           aes(x= reorder(name,value), y = value
                               ,fill = group_aggr
                           ))+
    geom_col() +
    coord_flip() + 
    #scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(value, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    #guides(fill="none") +
    theme(legend.position="bottom")

```


## Computing importance

### Overall all sample

Going further, we plot the importance overall first.
```{r}
# Importance - # Overall all sample
kable(ca.importance(brkfst_part, attribute),
      col.names = "Attribute importance")
```


Visualizing importance for the whole sample:

```{r}

## plot importance overall
sub_importance <- 
  ca.importance(brkfst_part, attribute)

sub_importance_df <- data.frame(
  sub_importance = sub_importance,
  attribute_txt = names(sub_importance)
)
sub_importance_df <- sub_importance_df %>% 
  mutate(group_fct = factor(attribute_txt, levels = c("Price", "Form", "PurchaseLocation",
                                                      "FunPackaging", "CognitiveSupport", "DigitalIntegration"
  )))

ggplot(sub_importance_df, aes(x=group_fct, y = sub_importance,
                              fill=group_fct)) +
  geom_col() +
  coord_flip() +
  scale_x_discrete(limits = rev(levels(sub_importance_df$group_fct))) +
  geom_text(aes(label = format(round(sub_importance, 2), nsmall = 2)), vjust = -0.5) +
  ggtitle(paste("All sample", length(brkfst$nickname), sep = ", n=")) +
  guides(fill="none")

```

It can be observed that for the whole sample, there are two variables that are very closely tied together: `Price` with 24% and `Form` with 24%. This suggests likely a trade-off between two different needs (low price and personal taste), which can be investigated through segmentation.


## Exploratory data analysis for subgroups
### Gender

We turn to subgroups. First, we explore the parthworth utility by gender:

```{r, fig.width=16, fig.height=14}
#segmenting part-worth utilities
# ===== 
# gender

plot_list <- list()
var_by = brkfst$gender
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  average_utility <- colMeans(brkfst_part[var_by==iter,,drop=FALSE])
  average_utility_df <- data.frame(level = names(average_utility),
                                   avg_utility = average_utility)
  
  average_utility_df <- 
    average_utility_df %>% 
    filter(level != "intercept")
  
  average_utility_df <- 
    average_utility_df %>% 
    mutate(group =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>% 
    mutate(level_fct = factor(level)) %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(order_rnk = level, rank) %>% 
    mutate(space_char = rep(c("L"), length(average_utility_df$level))) %>% 
    unite("lng_level", c("space_char","rank","level"))
  
  average_utility_df <- average_utility_df %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(lng_level = as.factor(lng_level)) %>% 
    mutate(lng_level = fct_reorder(lng_level, rank )) %>% 
    mutate(group_fct = factor(group, levels = c("Price", "Form", "PurchaseLocation",
                                                "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  
  plot_list[[i]] <- ggplot(average_utility_df, aes(x=lng_level, y = avg_utility
                                                   ,fill = group_fct
  ))+
    geom_col() +
    coord_flip() + 
    scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(avg_utility, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, length(brkfst$nickname), sep = ", n=")) +
    guides(fill="none")
}
grid.arrange(grobs=plot_list,ncol=2)

```

To visualize relative importance by gender, we can sort descending:
```{r, fig.width=16, fig.height=14}
# gender- sorted descending
plot_list <- list()
var_by = brkfst_cmb$gender
attr_levels <- unique(var_by)


for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_cmb[var_by == iter,1])
  
  brkfst_desc_slice <-  brkfst_cmb[var_by == iter,] %>% 
    mutate(item_col = iter) %>% 
    group_by(item_col) %>% 
    summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
                 mean , na.rm = TRUE) %>% 
    pivot_longer(-item_col) %>% 
    mutate(group_aggr =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>%
    mutate(group_aggr = 
             factor(group_aggr, levels = c("Price", "Form", "PurchaseLocation",
                                           "FunPackaging", "CognitiveSupport", "DigitalIntegration"
             ))) %>% 
    arrange(desc(value)) %>% 
    ungroup
  
  #kable(brkfst_desc_slice)
  
  
  plot_list[[i]] <- ggplot(brkfst_desc_slice, 
                           aes(x= reorder(name,value), y = value
                               ,fill = group_aggr
                           ))+
    geom_col() +
    coord_flip() + 
    #scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(value, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    #guides(fill="none") +
    theme(legend.position="bottom")
}
grid.arrange(grobs=plot_list,ncol=2)
```



Subsequently, the importance of gender becomes:

```{r}

#breakdown of importance by subcomponents
#### by gender
plot_list <- list()
var_by = brkfst$gender
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  sub_importance <- 
    ca.importance(brkfst_part[var_by == iter,], attribute)
  
  sub_importance_df <- data.frame(
    sub_importance = sub_importance,
    attribute_txt = names(sub_importance)
  )
  sub_importance_df <- sub_importance_df %>% 
    mutate(group_fct = factor(attribute_txt, levels = c("Price", "Form", "PurchaseLocation",
                                                        "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  plot_list[[i]] <- ggplot(sub_importance_df, aes(x=group_fct, y = sub_importance,
                                                  fill=group_fct)) +
    geom_col() +
    coord_flip() +
    scale_x_discrete(limits = rev(levels(sub_importance_df$group_fct))) +
    geom_text(aes(label = format(round(sub_importance, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    guides(fill="none")
}

grid.arrange(grobs=plot_list,ncol=2)
```

### Region

Turning to region, the partworth utilities:
```{r, fig.width=16, fig.height=14}

#segmenting part-worth utilities
# ===== 
# region

plot_list <- list()
var_by = brkfst$region
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  average_utility <- colMeans(brkfst_part[var_by==iter,,drop=FALSE])
  average_utility_df <- data.frame(level = names(average_utility),
                                   avg_utility = average_utility)
  
  average_utility_df <- 
    average_utility_df %>% 
    filter(level != "intercept")
  
  average_utility_df <- 
    average_utility_df %>% 
    mutate(group =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>% 
    mutate(level_fct = factor(level)) %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(order_rnk = level, rank) %>% 
    mutate(space_char = rep(c("L"), length(average_utility_df$level))) %>% 
    unite("lng_level", c("space_char","rank","level"))
  
  average_utility_df <- average_utility_df %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(lng_level = as.factor(lng_level)) %>% 
    mutate(lng_level = fct_reorder(lng_level, rank )) %>% 
    mutate(group_fct = factor(group, levels = c("Price", "Form", "PurchaseLocation",
                                                "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  
  plot_list[[i]] <- ggplot(average_utility_df, aes(x=lng_level, y = avg_utility
                                                   ,fill = group_fct
  ))+
    geom_col() +
    coord_flip() + 
    scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(avg_utility, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    guides(fill="none")
}
grid.arrange(grobs=plot_list,ncol=2)

```


To visualize relative importance by region, we can sort descending:
```{r, fig.width=16, fig.height=14}
# region - sorted descending
plot_list <- list()
var_by = brkfst_cmb$region
attr_levels <- unique(var_by)


for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_cmb[var_by == iter,1])
  
  brkfst_desc_slice <-  brkfst_cmb[var_by == iter,] %>% 
    mutate(item_col = iter) %>% 
    group_by(item_col) %>% 
    summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
                 mean , na.rm = TRUE) %>% 
    pivot_longer(-item_col) %>% 
    mutate(group_aggr =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>%
    mutate(group_aggr = 
             factor(group_aggr, levels = c("Price", "Form", "PurchaseLocation",
                                           "FunPackaging", "CognitiveSupport", "DigitalIntegration"
             ))) %>% 
    arrange(desc(value)) %>% 
    ungroup
  
  #kable(brkfst_desc_slice)
  
  
  plot_list[[i]] <- ggplot(brkfst_desc_slice, 
                           aes(x= reorder(name,value), y = value
                               ,fill = group_aggr
                           ))+
    geom_col() +
    coord_flip() + 
    #scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(value, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    #guides(fill="none")
    theme(legend.position = "bottom")
}
grid.arrange(grobs=plot_list,ncol=2)
```



The importance of region is as follows.

```{r}

#### by region
plot_list <- list()
var_by = brkfst$region
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  sub_importance <- 
    ca.importance(brkfst_part[var_by == iter,], attribute)
  
  sub_importance_df <- data.frame(
    sub_importance = sub_importance,
    attribute_txt = names(sub_importance)
  )
  sub_importance_df <- sub_importance_df %>% 
    mutate(group_fct = factor(attribute_txt, levels = c("Price", "Form", "PurchaseLocation",
                                                        "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  plot_list[[i]] <- ggplot(sub_importance_df, aes(x=group_fct, y = sub_importance,
                                                  fill=group_fct)) +
    geom_col() +
    coord_flip() +
    scale_x_discrete(limits = rev(levels(sub_importance_df$group_fct))) +
    geom_text(aes(label = format(round(sub_importance, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    guides(fill="none")
}

grid.arrange(grobs=plot_list,ncol=2)
```

### Age

Turning to Age, the parthworth utilities are:
```{r, fig.width=16, fig.height=14}
#segmenting part-worth utilities
# ===== 
# age

plot_list <- list()
var_by = brkfst$age
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  average_utility <- colMeans(brkfst_part[var_by==iter,,drop=FALSE])
  average_utility_df <- data.frame(level = names(average_utility),
                                   avg_utility = average_utility)
  
  average_utility_df <- 
    average_utility_df %>% 
    filter(level != "intercept")
  
  average_utility_df <- 
    average_utility_df %>% 
    mutate(group =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>% 
    mutate(level_fct = factor(level)) %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(order_rnk = level, rank) %>% 
    mutate(space_char = rep(c("L"), length(average_utility_df$level))) %>% 
    unite("lng_level", c("space_char","rank","level"))
  
  average_utility_df <- average_utility_df %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(lng_level = as.factor(lng_level)) %>% 
    mutate(lng_level = fct_reorder(lng_level, rank )) %>% 
    mutate(group_fct = factor(group, levels = c("Price", "Form", "PurchaseLocation",
                                                "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  
  plot_list[[i]] <- ggplot(average_utility_df, aes(x=lng_level, y = avg_utility
                                                   ,fill = group_fct
  ))+
    geom_col() +
    coord_flip() + 
    scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(avg_utility, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    guides(fill="none")
}
grid.arrange(grobs=plot_list,ncol=2)

```



To visualize relative importance by age, we can sort descending:
```{r, fig.width=16, fig.height=14}
# age - sorted descending
plot_list <- list()
var_by = brkfst_cmb$age
attr_levels <- unique(var_by)


for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_cmb[var_by == iter,1])
  
  brkfst_desc_slice <-  brkfst_cmb[var_by == iter,] %>% 
    mutate(item_col = iter) %>% 
    group_by(item_col) %>% 
    summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
                 mean , na.rm = TRUE) %>% 
    pivot_longer(-item_col) %>% 
    mutate(group_aggr =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>%
    mutate(group_aggr = 
             factor(group_aggr, levels = c("Price", "Form", "PurchaseLocation",
                                           "FunPackaging", "CognitiveSupport", "DigitalIntegration"
             ))) %>% 
    arrange(desc(value)) %>% 
    ungroup
  
  #kable(brkfst_desc_slice)
  
  
  plot_list[[i]] <- ggplot(brkfst_desc_slice, 
                           aes(x= reorder(name,value), y = value
                               ,fill = group_aggr
                           ))+
    geom_col() +
    coord_flip() + 
    #scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(value, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    #guides(fill="none")
    theme(legend.position = "bottom")
}
grid.arrange(grobs=plot_list,ncol=2)
```



The importance of Age is as follows.

```{r}
# importance
#### by age
plot_list <- list()
var_by = brkfst$age
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  sub_importance <- 
    ca.importance(brkfst_part[var_by == iter,], attribute)
  
  sub_importance_df <- data.frame(
    sub_importance = sub_importance,
    attribute_txt = names(sub_importance)
  )
  sub_importance_df <- sub_importance_df %>% 
    mutate(group_fct = factor(attribute_txt, levels = c("Price", "Form", "PurchaseLocation",
                                                        "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  plot_list[[i]] <- ggplot(sub_importance_df, aes(x=group_fct, y = sub_importance,
                                                  fill=group_fct)) +
    geom_col() +
    coord_flip() +
    scale_x_discrete(limits = rev(levels(sub_importance_df$group_fct))) +
    geom_text(aes(label = format(round(sub_importance, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n =")) +
    guides(fill="none")
}

grid.arrange(grobs=plot_list,ncol=2)
```

### Civil status

Exploring by whether a person is leaving with their partner or not. The partworth utilities of Civil Status are:
```{r, fig.width=16, fig.height=14}

#segmenting part-worth utilities
# ===== 
# living with partner

plot_list <- list()
var_by = brkfst$living_with_partner
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  average_utility <- colMeans(brkfst_part[var_by==iter,,drop=FALSE])
  average_utility_df <- data.frame(level = names(average_utility),
                                   avg_utility = average_utility)
  
  average_utility_df <- 
    average_utility_df %>% 
    filter(level != "intercept")
  
  average_utility_df <- 
    average_utility_df %>% 
    mutate(group =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>% 
    mutate(level_fct = factor(level)) %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(order_rnk = level, rank) %>% 
    mutate(space_char = rep(c("L"), length(average_utility_df$level))) %>% 
    unite("lng_level", c("space_char","rank","level"))
  
  average_utility_df <- average_utility_df %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(lng_level = as.factor(lng_level)) %>% 
    mutate(lng_level = fct_reorder(lng_level, rank )) %>% 
    mutate(group_fct = factor(group, levels = c("Price", "Form", "PurchaseLocation",
                                                "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  
  plot_list[[i]] <- ggplot(average_utility_df, aes(x=lng_level, y = avg_utility
                                                   ,fill = group_fct
  ))+
    geom_col() +
    coord_flip() + 
    scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(avg_utility, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    guides(fill="none")
}
grid.arrange(grobs=plot_list,ncol=2)
```



To visualize relative importance by civil status, we can sort descending:
```{r, fig.width=16, fig.height=14}
# civil status - sorted descending
plot_list <- list()
var_by = brkfst_cmb$living_with_partner
attr_levels <- unique(var_by)


for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_cmb[var_by == iter,1])
  
  brkfst_desc_slice <-  brkfst_cmb[var_by == iter,] %>% 
    mutate(item_col = iter) %>% 
    group_by(item_col) %>% 
    summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
                 mean , na.rm = TRUE) %>% 
    pivot_longer(-item_col) %>% 
    mutate(group_aggr =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>%
    mutate(group_aggr = 
             factor(group_aggr, levels = c("Price", "Form", "PurchaseLocation",
                                           "FunPackaging", "CognitiveSupport", "DigitalIntegration"
             ))) %>% 
    arrange(desc(value)) %>% 
    ungroup
  
  #kable(brkfst_desc_slice)
  
  
  plot_list[[i]] <- ggplot(brkfst_desc_slice, 
                           aes(x= reorder(name,value), y = value
                               ,fill = group_aggr
                           ))+
    geom_col() +
    coord_flip() + 
    #scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(value, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    #guides(fill="none")
    theme(legend.position = "bottom")
}
grid.arrange(grobs=plot_list,ncol=2)
```



The importance of Civil Status is:

```{r}
# importance
#### by living with partner
plot_list <- list()
var_by = brkfst$living_with_partner
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  sub_importance <- 
    ca.importance(brkfst_part[var_by == iter,], attribute)
  
  sub_importance_df <- data.frame(
    sub_importance = sub_importance,
    attribute_txt = names(sub_importance)
  )
  sub_importance_df <- sub_importance_df %>% 
    mutate(group_fct = factor(attribute_txt, levels = c("Price", "Form", "PurchaseLocation",
                                                        "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  plot_list[[i]] <- ggplot(sub_importance_df, aes(x=group_fct, y = sub_importance,
                                                  fill=group_fct)) +
    geom_col() +
    coord_flip() +
    scale_x_discrete(limits = rev(levels(sub_importance_df$group_fct))) +
    geom_text(aes(label = format(round(sub_importance, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n =")) +
    guides(fill="none")
}

grid.arrange(grobs=plot_list,ncol=2)

```

### Expected Salary

Reflecting career ladder status and aspirations. The partworth utilities are:

```{r, fig.width=16, fig.height=14}

#segmenting part-worth utilities
# ===== 
# living with partner

plot_list <- list()
var_by = brkfst$expected_salary
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  average_utility <- colMeans(brkfst_part[var_by==iter,,drop=FALSE])
  average_utility_df <- data.frame(level = names(average_utility),
                                   avg_utility = average_utility)
  
  average_utility_df <- 
    average_utility_df %>% 
    filter(level != "intercept")
  
  average_utility_df <- 
    average_utility_df %>% 
    mutate(group =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>% 
    mutate(level_fct = factor(level)) %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(order_rnk = level, rank) %>% 
    mutate(space_char = rep(c("L"), length(average_utility_df$level))) %>% 
    unite("lng_level", c("space_char","rank","level"))
  
  average_utility_df <- average_utility_df %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(lng_level = as.factor(lng_level)) %>% 
    mutate(lng_level = fct_reorder(lng_level, rank )) %>% 
    mutate(group_fct = factor(group, levels = c("Price", "Form", "PurchaseLocation",
                                                "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  
  plot_list[[i]] <- ggplot(average_utility_df, aes(x=lng_level, y = avg_utility
                                                   ,fill = group_fct
  ))+
    geom_col() +
    coord_flip() + 
    scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(avg_utility, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    guides(fill="none")
}
grid.arrange(grobs=plot_list,ncol=2)
```



To visualize relative importance by expected salary, we can sort descending:
```{r, fig.width=16, fig.height=14}
# expected salary - sorted descending
plot_list <- list()
var_by = brkfst_cmb$expected_salary
attr_levels <- unique(var_by)


for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_cmb[var_by == iter,1])
  
  brkfst_desc_slice <-  brkfst_cmb[var_by == iter,] %>% 
    mutate(item_col = iter) %>% 
    group_by(item_col) %>% 
    summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
                 mean , na.rm = TRUE) %>% 
    pivot_longer(-item_col) %>% 
    mutate(group_aggr =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>%
    mutate(group_aggr = 
             factor(group_aggr, levels = c("Price", "Form", "PurchaseLocation",
                                           "FunPackaging", "CognitiveSupport", "DigitalIntegration"
             ))) %>% 
    arrange(desc(value)) %>% 
    ungroup
  
  #kable(brkfst_desc_slice)
  
  
  plot_list[[i]] <- ggplot(brkfst_desc_slice, 
                           aes(x= reorder(name,value), y = value
                               ,fill = group_aggr
                           ))+
    geom_col() +
    coord_flip() + 
    #scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(value, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    #guides(fill="none")
    theme(legend.position = "bottom")
}
grid.arrange(grobs=plot_list,ncol=2)
```



The importance thus is:

```{r}

#### by expected salary
plot_list <- list()
var_by = brkfst$expected_salary
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  sub_importance <- 
    ca.importance(brkfst_part[var_by == iter,], attribute)
  
  sub_importance_df <- data.frame(
    sub_importance = sub_importance,
    attribute_txt = names(sub_importance)
  )
  sub_importance_df <- sub_importance_df %>% 
    mutate(group_fct = factor(attribute_txt, levels = c("Price", "Form", "PurchaseLocation",
                                                        "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  plot_list[[i]] <- ggplot(sub_importance_df, aes(x=group_fct, y = sub_importance,
                                                  fill=group_fct)) +
    geom_col() +
    coord_flip() +
    scale_x_discrete(limits = rev(levels(sub_importance_df$group_fct))) +
    geom_text(aes(label = format(round(sub_importance, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n =")) +
    guides(fill="none")
}

grid.arrange(grobs=plot_list,ncol=2)


```

### Dietary restrictions

Exploring the impact of personal dietary restrictions. Partworth utilities are:

```{r, fig.width=16, fig.height=14}
#segmenting part-worth utilities
# ===== 
# dietary restriction

plot_list <- list()
var_by = brkfst$dietary_restrictions
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  average_utility <- colMeans(brkfst_part[var_by==iter,,drop=FALSE])
  average_utility_df <- data.frame(level = names(average_utility),
                                   avg_utility = average_utility)
  
  average_utility_df <- 
    average_utility_df %>% 
    filter(level != "intercept")
  
  average_utility_df <- 
    average_utility_df %>% 
    mutate(group =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>% 
    mutate(level_fct = factor(level)) %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(order_rnk = level, rank) %>% 
    mutate(space_char = rep(c("L"), length(average_utility_df$level))) %>% 
    unite("lng_level", c("space_char","rank","level"))
  
  average_utility_df <- average_utility_df %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(lng_level = as.factor(lng_level)) %>% 
    mutate(lng_level = fct_reorder(lng_level, rank )) %>% 
    mutate(group_fct = factor(group, levels = c("Price", "Form", "PurchaseLocation",
                                                "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  
  plot_list[[i]] <- ggplot(average_utility_df, aes(x=lng_level, y = avg_utility
                                                   ,fill = group_fct
  ))+
    geom_col() +
    coord_flip() + 
    scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(avg_utility, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    guides(fill="none")
}
grid.arrange(grobs=plot_list,ncol=2)
```



To visualize relative importance by dietary restrictions, we can sort descending:
```{r, fig.width=16, fig.height=14}
# dietary restrictions - sorted descending
plot_list <- list()
var_by = brkfst_cmb$dietary_restrictions
attr_levels <- unique(var_by)


for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_cmb[var_by == iter,1])
  
  brkfst_desc_slice <-  brkfst_cmb[var_by == iter,] %>% 
    mutate(item_col = iter) %>% 
    group_by(item_col) %>% 
    summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
                 mean , na.rm = TRUE) %>% 
    pivot_longer(-item_col) %>% 
    mutate(group_aggr =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>%
    mutate(group_aggr = 
             factor(group_aggr, levels = c("Price", "Form", "PurchaseLocation",
                                           "FunPackaging", "CognitiveSupport", "DigitalIntegration"
             ))) %>% 
    arrange(desc(value)) %>% 
    ungroup
  
  #kable(brkfst_desc_slice)
  
  
  plot_list[[i]] <- ggplot(brkfst_desc_slice, 
                           aes(x= reorder(name,value), y = value
                               ,fill = group_aggr
                           ))+
    geom_col() +
    coord_flip() + 
    #scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(value, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    #guides(fill="none")
    theme(legend.position = "bottom")
}
grid.arrange(grobs=plot_list,ncol=2)
```



The importance is:

```{r}
## importance
#### by dietary restriction
plot_list <- list()
var_by = brkfst$dietary_restrictions
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  sub_importance <- 
    ca.importance(brkfst_part[var_by == iter,], attribute)
  
  sub_importance_df <- data.frame(
    sub_importance = sub_importance,
    attribute_txt = names(sub_importance)
  )
  sub_importance_df <- sub_importance_df %>% 
    mutate(group_fct = factor(attribute_txt, levels = c("Price", "Form", "PurchaseLocation",
                                                        "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  plot_list[[i]] <- ggplot(sub_importance_df, aes(x=group_fct, y = sub_importance,
                                                  fill=group_fct)) +
    geom_col() +
    coord_flip() +
    scale_x_discrete(limits = rev(levels(sub_importance_df$group_fct))) +
    geom_text(aes(label = format(round(sub_importance, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n =")) +
    guides(fill="none")
}

grid.arrange(grobs=plot_list,ncol=2)

```

### Work start

Breaking down by the time that the work day starts. The parthworth utilities:
```{r, fig.width=16, fig.height=14}

#segmenting part-worth utilities
# ===== 
# work_start cut

plot_list <- list()
var_by = brkfst$work_start_cut
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  average_utility <- colMeans(brkfst_part[var_by==iter,,drop=FALSE])
  average_utility_df <- data.frame(level = names(average_utility),
                                   avg_utility = average_utility)
  
  average_utility_df <- 
    average_utility_df %>% 
    filter(level != "intercept")
  
  average_utility_df <- 
    average_utility_df %>% 
    mutate(group =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>% 
    mutate(level_fct = factor(level)) %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(order_rnk = level, rank) %>% 
    mutate(space_char = rep(c("L"), length(average_utility_df$level))) %>% 
    unite("lng_level", c("space_char","rank","level"))
  
  average_utility_df <- average_utility_df %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(lng_level = as.factor(lng_level)) %>% 
    mutate(lng_level = fct_reorder(lng_level, rank )) %>% 
    mutate(group_fct = factor(group, levels = c("Price", "Form", "PurchaseLocation",
                                                "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  
  plot_list[[i]] <- ggplot(average_utility_df, aes(x=lng_level, y = avg_utility
                                                   ,fill = group_fct
  ))+
    geom_col() +
    coord_flip() + 
    scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(avg_utility, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    guides(fill="none")
}
grid.arrange(grobs=plot_list,ncol=2)
```


To visualize relative importance by work start time, we can sort descending:
```{r, fig.width=16, fig.height=14}
# work start cut - sorted descending
plot_list <- list()
var_by = brkfst_cmb$work_start_cut
attr_levels <- unique(var_by)


for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_cmb[var_by == iter,1])
  
  brkfst_desc_slice <-  brkfst_cmb[var_by == iter,] %>% 
    mutate(item_col = iter) %>% 
    group_by(item_col) %>% 
    summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
                 mean , na.rm = TRUE) %>% 
    pivot_longer(-item_col) %>% 
    mutate(group_aggr =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>%
    mutate(group_aggr = 
             factor(group_aggr, levels = c("Price", "Form", "PurchaseLocation",
                                           "FunPackaging", "CognitiveSupport", "DigitalIntegration"
             ))) %>% 
    arrange(desc(value)) %>% 
    ungroup
  
  #kable(brkfst_desc_slice)
  
  
  plot_list[[i]] <- ggplot(brkfst_desc_slice, 
                           aes(x= reorder(name,value), y = value
                               ,fill = group_aggr
                           ))+
    geom_col() +
    coord_flip() + 
    #scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(value, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    #guides(fill="none")
    theme(legend.position = "bottom")
}
grid.arrange(grobs=plot_list,ncol=2)
```


The work start importance:

```{r}

#### by work start
plot_list <- list()
var_by = brkfst$work_start_cut
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  sub_importance <- 
    ca.importance(brkfst_part[var_by == iter,], attribute)
  
  sub_importance_df <- data.frame(
    sub_importance = sub_importance,
    attribute_txt = names(sub_importance)
  )
  sub_importance_df <- sub_importance_df %>% 
    mutate(group_fct = factor(attribute_txt, levels = c("Price", "Form", "PurchaseLocation",
                                                        "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  plot_list[[i]] <- ggplot(sub_importance_df, aes(x=group_fct, y = sub_importance,
                                                  fill=group_fct)) +
    geom_col() +
    coord_flip() +
    scale_x_discrete(limits = rev(levels(sub_importance_df$group_fct))) +
    geom_text(aes(label = format(round(sub_importance, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n =")) +
    guides(fill="none")
}

grid.arrange(grobs=plot_list,ncol=2)

```

### Exercise frequency

The number of times a person exercises per week. Partworth utilities:
```{r, fig.width=16, fig.height=14}

#segmenting part-worth utilities
# ===== 
# exercise per week cut

plot_list <- list()
var_by = brkfst$exercise_per_week_cut
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  average_utility <- colMeans(brkfst_part[var_by==iter,,drop=FALSE])
  average_utility_df <- data.frame(level = names(average_utility),
                                   avg_utility = average_utility)
  
  average_utility_df <- 
    average_utility_df %>% 
    filter(level != "intercept")
  
  average_utility_df <- 
    average_utility_df %>% 
    mutate(group =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>% 
    mutate(level_fct = factor(level)) %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(order_rnk = level, rank) %>% 
    mutate(space_char = rep(c("L"), length(average_utility_df$level))) %>% 
    unite("lng_level", c("space_char","rank","level"))
  
  average_utility_df <- average_utility_df %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(lng_level = as.factor(lng_level)) %>% 
    mutate(lng_level = fct_reorder(lng_level, rank )) %>% 
    mutate(group_fct = factor(group, levels = c("Price", "Form", "PurchaseLocation",
                                                "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  
  plot_list[[i]] <- ggplot(average_utility_df, aes(x=lng_level, y = avg_utility
                                                   ,fill = group_fct
  ))+
    geom_col() +
    coord_flip() + 
    scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(avg_utility, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    guides(fill="none")
}
grid.arrange(grobs=plot_list,ncol=2)
```



To visualize relative importance by exercise frequency, we can sort descending:
```{r, fig.width=16, fig.height=14}
# exercise frequency - sorted descending
plot_list <- list()
var_by = brkfst_cmb$exercise_per_week_cut
attr_levels <- unique(var_by)


for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_cmb[var_by == iter,1])
  
  brkfst_desc_slice <-  brkfst_cmb[var_by == iter,] %>% 
    mutate(item_col = iter) %>% 
    group_by(item_col) %>% 
    summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
                 mean , na.rm = TRUE) %>% 
    pivot_longer(-item_col) %>% 
    mutate(group_aggr =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>%
    mutate(group_aggr = 
             factor(group_aggr, levels = c("Price", "Form", "PurchaseLocation",
                                           "FunPackaging", "CognitiveSupport", "DigitalIntegration"
             ))) %>% 
    arrange(desc(value)) %>% 
    ungroup
  
  #kable(brkfst_desc_slice)
  
  
  plot_list[[i]] <- ggplot(brkfst_desc_slice, 
                           aes(x= reorder(name,value), y = value
                               ,fill = group_aggr
                           ))+
    geom_col() +
    coord_flip() + 
    #scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(value, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    #guides(fill="none")
    theme(legend.position = "bottom")
}
grid.arrange(grobs=plot_list,ncol=2)
```




The importance is:

```{r}

#### by exercise per week
plot_list <- list()
var_by = brkfst$exercise_per_week_cut
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  sub_importance <- 
    ca.importance(brkfst_part[var_by == iter,], attribute)
  
  sub_importance_df <- data.frame(
    sub_importance = sub_importance,
    attribute_txt = names(sub_importance)
  )
  sub_importance_df <- sub_importance_df %>% 
    mutate(group_fct = factor(attribute_txt, levels = c("Price", "Form", "PurchaseLocation",
                                                        "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  plot_list[[i]] <- ggplot(sub_importance_df, aes(x=group_fct, y = sub_importance,
                                                  fill=group_fct)) +
    geom_col() +
    coord_flip() +
    scale_x_discrete(limits = rev(levels(sub_importance_df$group_fct))) +
    geom_text(aes(label = format(round(sub_importance, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n =")) +
    guides(fill="none")
}

grid.arrange(grobs=plot_list,ncol=2)
```

### Alcohol consumption

How much a person's love for drinking influences their breakfast preferences. The parthworth utilities:
```{r, fig.width=16, fig.height=14}

#segmenting part-worth utilities
# ===== 
# alcohol per week
plot_list <- list()
var_by = brkfst$alcohol_per_week
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  average_utility <- colMeans(brkfst_part[var_by==iter,,drop=FALSE])
  average_utility_df <- data.frame(level = names(average_utility),
                                   avg_utility = average_utility)
  
  average_utility_df <- 
    average_utility_df %>% 
    filter(level != "intercept")
  
  average_utility_df <- 
    average_utility_df %>% 
    mutate(group =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>% 
    mutate(level_fct = factor(level)) %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(order_rnk = level, rank) %>% 
    mutate(space_char = rep(c("L"), length(average_utility_df$level))) %>% 
    unite("lng_level", c("space_char","rank","level"))
  
  average_utility_df <- average_utility_df %>% 
    mutate(rank = seq.int(1:length(average_utility_df$level))) %>% 
    mutate(lng_level = as.factor(lng_level)) %>% 
    mutate(lng_level = fct_reorder(lng_level, rank )) %>% 
    mutate(group_fct = factor(group, levels = c("Price", "Form", "PurchaseLocation",
                                                "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  
  plot_list[[i]] <- ggplot(average_utility_df, aes(x=lng_level, y = avg_utility
                                                   ,fill = group_fct
  ))+
    geom_col() +
    coord_flip() + 
    scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(avg_utility, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    guides(fill="none")
}
grid.arrange(grobs=plot_list,ncol=2)

```


To visualize relative importance by alcohol consumption, we can sort descending:
```{r, fig.width=16, fig.height=14}
# alcohol consumption - sorted descending
plot_list <- list()
var_by = brkfst_cmb$alcohol_per_week
attr_levels <- unique(var_by)


for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_cmb[var_by == iter,1])
  
  brkfst_desc_slice <-  brkfst_cmb[var_by == iter,] %>% 
    mutate(item_col = iter) %>% 
    group_by(item_col) %>% 
    summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
                 mean , na.rm = TRUE) %>% 
    pivot_longer(-item_col) %>% 
    mutate(group_aggr =
             c("Price", "Price", "Price",
               "Form", "Form", "Form",
               "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
               "FunPackaging", "FunPackaging", "FunPackaging",
               "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
               "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
             )) %>%
    mutate(group_aggr = 
             factor(group_aggr, levels = c("Price", "Form", "PurchaseLocation",
                                           "FunPackaging", "CognitiveSupport", "DigitalIntegration"
             ))) %>% 
    arrange(desc(value)) %>% 
    ungroup
  
  #kable(brkfst_desc_slice)
  
  
  plot_list[[i]] <- ggplot(brkfst_desc_slice, 
                           aes(x= reorder(name,value), y = value
                               ,fill = group_aggr
                           ))+
    geom_col() +
    coord_flip() + 
    #scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
    geom_text(aes(label = format(round(value, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n=")) +
    #guides(fill="none")
    theme(legend.position = "bottom")
}
grid.arrange(grobs=plot_list,ncol=2)
```



The importance of alcohol consumption:

```{r}


#### by alcohol per week
plot_list <- list()
var_by = brkfst$alcohol_per_week
attr_levels <- unique(var_by)

for (i in seq_along(attr_levels)) {
  
  iter = attr_levels[i]
  n_obs = length(brkfst_part[var_by == iter,1])
  
  sub_importance <- 
    ca.importance(brkfst_part[var_by == iter,], attribute)
  
  sub_importance_df <- data.frame(
    sub_importance = sub_importance,
    attribute_txt = names(sub_importance)
  )
  sub_importance_df <- sub_importance_df %>% 
    mutate(group_fct = factor(attribute_txt, levels = c("Price", "Form", "PurchaseLocation",
                                                        "FunPackaging", "CognitiveSupport", "DigitalIntegration"
    )))
  
  plot_list[[i]] <- ggplot(sub_importance_df, aes(x=group_fct, y = sub_importance,
                                                  fill=group_fct)) +
    geom_col() +
    coord_flip() +
    scale_x_discrete(limits = rev(levels(sub_importance_df$group_fct))) +
    geom_text(aes(label = format(round(sub_importance, 2), nsmall = 2)), vjust = -0.5) +
    ggtitle(paste(iter, n_obs, sep = ", n =")) +
    guides(fill="none")
}

grid.arrange(grobs=plot_list,ncol=2)

```

## Segmentation
### Estimation and Interpretation
To gain insight into behavioral subgroups, we run a segmentation analysis. To decide the number of clusters, we first look at the silhouette plot.

```{r}
# exclude intercept column
brkfst_part_sg <- data.frame(brkfst_part[,-1])
names(brkfst_part_sg)[10] <- c("No special packaging")
names(brkfst_part_sg)[13] <- c("No cognitive support")
names(brkfst_part_sg)[16] <- c("No digital integration")

# silhouette plot
fviz_nbclust(brkfst_part_sg, kmeans, method="silhouette")
```

Estimating four clusters:

```{r}
# estimating clusters
brkfst_sg_4 <- k.means(brkfst_part_sg, n.cluster=4)

# Cluster sizes
prop.table(brkfst_sg_4$size)

# interpreting clusters
snake.ch2(brkfst_sg_4)

#Cluster plot
fviz_cluster(brkfst_sg_4, brkfst_part_sg, ellipse.type = "convex",
             ggtheme = theme_minimal())
```

Estimating seven clusters:

```{r}
# estimating clusters
brkfst_sg_7 <- k.means(brkfst_part_sg, n.cluster=7)

# Cluster sizes
prop.table(brkfst_sg_7$size)

# interpreting clusters
snake.ch2(brkfst_sg_7)

#Cluster plot
fviz_cluster(brkfst_sg_7, brkfst_part_sg, ellipse.type = "convex",
             ggtheme = theme_minimal())
```


### Segment composition
To visualize composition of each cluster - we create a table of each cluster.

To view individual names, we have to replace the variable `"country2"` with `"nickname"` in the code below.

```{r}
## segment composition -----
# For analysis: Keep as separate vectors
brkfst_clst <- cbind(brkfst_cmb, 
                     cluster = brkfst_sg_4$cluster)

cluster1_names <- brkfst_clst[brkfst_clst$cluster == 1, "country2"]
cluster2_names <- brkfst_clst[brkfst_clst$cluster == 2, "country2"]
cluster3_names <- brkfst_clst[brkfst_clst$cluster == 3, "country2"]
cluster4_names <- brkfst_clst[brkfst_clst$cluster == 4, "country2"]


# For presentation: Create NA-padded data frame
presentation_df <- data.frame(
  cluster1 = c(cluster1_names, rep(NA, length(cluster1_names) - length(cluster1_names))),
  cluster2 = c(cluster2_names, rep(NA, length(cluster1_names) - length(cluster2_names))),
  cluster3 = c(cluster3_names, rep(NA, length(cluster1_names) - length(cluster3_names))),
  cluster4 = c(cluster4_names, rep(NA, length(cluster1_names) - length(cluster4_names)))
)

kable(presentation_df)

```




## Trade-off calculation

We first prepare the object for trade-off:
```{r}
### allocate separate object for all trade-off calculation
average_utility <- colMeans(brkfst_part)
average_utility_df_all <- data.frame(level = names(average_utility),
                                     avg_utility = average_utility)

average_utility_df_all <- 
  average_utility_df_all %>% 
  filter(level != "intercept")

average_utility_df_all  <- 
  average_utility_df_all  %>% 
  mutate(group =
           c("Price", "Price", "Price",
             "Form", "Form", "Form",
             "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
             "FunPackaging", "FunPackaging", "FunPackaging",
             "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
             "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
           )) %>% 
  mutate(level_fct = factor(level)) %>% 
  mutate(rank = seq.int(1:length(average_utility_df_all$level))) %>% 
  mutate(order_rnk = level, rank) %>% 
  mutate(space_char = rep(c("L"), length(average_utility_df_all$level))) %>% 
  unite("lng_level", c("space_char","rank","level"))

average_utility_df_all <- average_utility_df_all %>% 
  mutate(rank = seq.int(1:length(average_utility_df_all$level))) %>% 
  mutate(lng_level = as.factor(lng_level)) %>% 
  mutate(lng_level = fct_reorder(lng_level, rank )) %>% 
  mutate(group_fct = factor(group, levels = c("Price", "Form", "PurchaseLocation",
                                              "FunPackaging", "CognitiveSupport", "DigitalIntegration"
  )))
```


Subsequently, we can calculate the average value of one monetary utility: 

$\frac{600 - 200}{0.513-(-0.572)}$ = 368.85

```{r}


# average monetary value of 1 utiliy
# linear utility function
util_linear_value <-  (600-200)/
  (average_utility_df_all[average_utility_df_all$lng_level ==
                            "L_1_200",]$avg_utility-
     average_utility_df_all[average_utility_df_all$lng_level ==
                              "L_3_600",]$avg_utility)
util_linear_value

# piece-wise utility function
util_piecewise_1 <- (600-400)/(average_utility["400"]-average_utility["600"])
util_piecewise_1
util_piecewise_2 <- (400-200)/(average_utility["200"]-average_utility["400"])
util_piecewise_2  
```


To visualize the trade-off, we can plot:
```{r}
tri_df_points <- 
  data.frame(
    price = c(200, 600),
    utility = 
      c(average_utility_df_all[average_utility_df_all$lng_level ==
                                 "L_1_200",]$avg_utility,
        average_utility_df_all[average_utility_df_all$lng_level ==
                                 "L_3_600",]$avg_utility)
  )

ggplot(tri_df_points, 
       aes(x = price, y = utility)) +
  geom_point() + geom_line()

```


Going from no cognitive support to Caffeine and Alertness boost, the client would be willing to pay more:

```{r}

# moving from none to caffeine or alertness boost
delta_cognitive_support_none_caffeine <- (average_utility_df_all[average_utility_df_all$lng_level=="L_14_Caffeine or Alertness boost",]$avg_utility -
                                            average_utility_df_all[average_utility_df_all$lng_level=="L_13_None",]$avg_utility) * util_linear_value
delta_cognitive_support_none_caffeine

```

Going from no cognitive support to Natural Mood stabilizer, the client would be willing to pay more:

```{r}
# moving from none to natural mood stabilizers
delta_cognitive_support_none_naturalmood <- 
  (average_utility_df_all[average_utility_df_all$lng_level=="L_15_Natural Mood Stabilizer",]$avg_utility -
     average_utility_df_all[average_utility_df_all$lng_level=="L_13_None",]$avg_utility) * util_linear_value
delta_cognitive_support_none_naturalmood

```


## Market share prediction
### Commercial considerations
Before deciding on a product launch, it may be useful to review the preferences of the Japanese consumer.

The parthworth for the Japanese consumer:
```{r}
## tastes of the Japanese consumer
## partworth - sorted descending For Japan
iter = "Japan"
n_obs = length(brkfst_cmb[brkfst_cmb$country2 == iter,1])

brkfst_desc_slice <-  brkfst_cmb[brkfst_cmb$country2 == iter,] %>% 
  mutate(item_col = iter) %>% 
  group_by(item_col) %>% 
  summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
               mean , na.rm = TRUE) %>% 
  pivot_longer(-item_col) %>% 
  mutate(group_aggr =
           c("Price", "Price", "Price",
             "Form", "Form", "Form",
             "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
             "FunPackaging", "FunPackaging", "FunPackaging",
             "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
             "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
           )) %>%
  mutate(group_aggr = 
           factor(group_aggr, levels = c("Price", "Form", "PurchaseLocation",
                                         "FunPackaging", "CognitiveSupport", "DigitalIntegration"
           ))) %>% 
  arrange(desc(value)) %>% 
  ungroup

ggplot(brkfst_desc_slice, 
       aes(x= reorder(name,value), y = value
           ,fill = group_aggr
       ))+
  geom_col() +
  coord_flip() + 
  #scale_x_discrete(limits = rev(levels(average_utility_df$lng_level))) +
  geom_text(aes(label = format(round(value, 2), nsmall = 2)), vjust = -0.5) +
  ggtitle(paste(iter, n_obs, sep = ", n=")) +
  guides(fill="none")


```

And the importance:
```{r}

## importance of attributes for the Japanese consumer
#### Japan - importance
iter = "Japan"
var_by = brkfst$country2

n_obs = length(brkfst_part[var_by == iter,1])

sub_importance <- 
  ca.importance(brkfst_part[var_by == iter,], attribute)

sub_importance_df <- data.frame(
  sub_importance = sub_importance,
  attribute_txt = names(sub_importance)
)
sub_importance_df <- sub_importance_df %>% 
  mutate(group_fct = factor(attribute_txt, levels = c("Price", "Form", "PurchaseLocation",
                                                      "FunPackaging", "CognitiveSupport", "DigitalIntegration"
  )))

ggplot(sub_importance_df, aes(x=group_fct, y = sub_importance,
                              fill=group_fct)) +
  geom_col() +
  coord_flip() +
  scale_x_discrete(limits = rev(levels(sub_importance_df$group_fct))) +
  geom_text(aes(label = format(round(sub_importance, 2), nsmall = 2)), vjust = -0.5) +
  ggtitle(paste(iter, n_obs, sep = ", n=")) +
  guides(fill="none")

```


### Estimation of market share (Logit)
In order to test our potential market share, we benchmark against four existing alternatives:

-   the pastrami croissant from Paul Shimbashi
-   the 7-Eleven onigiri
-   the melonpan at Shimbashi cafe
-   the Family Mart protein stick

```{r}

# Market Prediction
## 5 benchmarks
## Paul shimbashi, pastrami croissant
brkfst_sim <- data.frame(
  Price = c("600"),
  Form = c("Bread and Pastries"),
  PurchaseLocation = c("On Route to work"),
  FunPackaging = c("None"),
  CognitiveSupport = c("None"),
  DigitalIntegration = c("None")
)

# 7-eleven onigiri
brkfst_sim <- rbind(brkfst_sim,
                    c("200","Onigiri","On Route to work","None","None","None"))


# Shimbashi cafe melonpan
brkfst_sim <- rbind(brkfst_sim,
                    c("600","Bread and Pastries","On Route to work","Attack on Titan","None","None"))



# Family Mart protein stick okaki
brkfst_sim <- rbind(brkfst_sim,
                    c("400","Protein sticks","Within 150m","None","None","None"))


# Our own product
brkfst_sim <- rbind(brkfst_sim,
                    c("400","Onigiri","Within 150m","Attack on Titan",
                      "Natural Mood Stabilizer","Loyalty points"))
```

Computing our market share:

```{r}

market_share <- 
  data.frame(product = c("Paul pastrami croissant",
                         "7-eleven onigiri",
                         "Shimbashi cafe",
                         "Family Mart protein stick",
                         "MCU new excellent product"),
             mkt_share = ca.logit(brkfst_sim, brkfst_part, brkfst_design))

ggplot(market_share, aes(x= product, y = mkt_share,
                         fill=product)) +
  geom_col() +
  coord_flip() +
  scale_x_discrete(limits=rev) +
  geom_text(aes(label = format(round(mkt_share, 2), nsmall = 2)), vjust = -0.5)


```

It seems it is not easy to beat the trusted onigiri in Japan.


## Appendix - Various data tables
Code for various tables.

### Partworth by variable
To compute the parthworth by a specific variable, we can run:

```{r}
## code for tables -----
### for variables
var_by <-  "exercise_per_week_cut"

kable(
  brkfst_cmb %>% 
    group_by(group_var = eval(as.name(paste(var_by)))) %>% 
    summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
                 mean , na.rm = TRUE) %>% 
    pivot_longer(-group_var) %>% 
    pivot_wider(id_cols = name, names_from = "group_var",
                values_from = "value")
)


```


### Partworth by observations
To investigate specific observations or subgroups we use the `filter()` function, passing the variable and specific observations, as below:
```{r}

### for specific observations
kable(
  brkfst_cmb %>% 
    filter(nickname %in% c("Marius", "Abigail", "Yun", "Matt", "Pup")) %>% 
    group_by(nickname) %>% 
    summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
                 mean , na.rm = TRUE) %>% 
    pivot_longer(-nickname) %>% 
    pivot_wider(id_cols = name, names_from = "nickname",
                values_from = "value")
)

```


### Comparing two countries
To compare two specific countries, for example China and Japan, we can run:
```{r, fig.width=16, fig.height=14}

## country comparison
brkfst_cmb %>% 
  filter(country2 %in% c("Japan", "China")) %>% 
  group_by(country2) %>% 
  summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
               mean , na.rm = TRUE) %>% 
  pivot_longer(-country2) %>% 
  pivot_wider(id_cols = name, names_from = "country2",
              values_from = "value") 

brkfst_cmb_plot <- brkfst_cmb %>% 
  filter(country2 %in% c("Japan", "China")) %>% 
  group_by(country2) %>% 
  summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
               mean , na.rm = TRUE) %>% 
  pivot_longer(-country2) %>% 
  # mutate(country2 = factor(country2,
  #                          levels = c("Japan", "China"))) %>% 
  mutate(name = factor(name,
                       levels = c("L_1_200", 
                                  "L_2_400",
                                  "L_3_600",
                                  "L_4_Bread and Pastries",
                                  "L_5_Onigiri",
                                  "L_6_Protein sticks",
                                  "L_7_On Route to work",
                                  "L_8_Within 150m",
                                  "L_9_More than 150m",
                                  "L_10_None",
                                  "L_11_Attack on Titan",
                                  "L_12_Doan Ritsu",
                                  "L_13_None",
                                  "L_14_Caffeine or Alertness boost",
                                  "L_15_Natural Mood Stabilizer",
                                  "L_16_None",
                                  "L_17_Loyalty points",
                                  "L_18_Nutrition Advice")))

ggplot(brkfst_cmb_plot, aes(x=name , y = value,
                            group = country2, fill=country2)) +
  geom_col(position = "dodge") +
  coord_flip() +
  scale_x_discrete(limits = rev(levels(brkfst_cmb_plot$name))) +
  geom_text(aes(label = format(round(value, 2), nsmall = 2)), vjust = -0.5) 
#ggtitle(paste(iter, n_obs, sep = ", n =")) +
#guides(fill="none")


```


### The Japanese Consumer
To see the parthworth only for the Japanese subgroup, we run:
```{r}

brkfst_cmb %>% 
  filter(country2 %in% c("Japan")) %>% 
  group_by(country2) %>% 
  summarise_at(vars(L_1_200:`L_18_Nutrition Advice`),
               mean , na.rm = TRUE) %>% 
  pivot_longer(-country2) %>% 
  # mutate(country2 = factor(country2,
  #                          levels = c("Japan", "China"))) %>% 
  mutate(name = factor(name,
                       levels = c("L_1_200", 
                                  "L_2_400",
                                  "L_3_600",
                                  "L_4_Bread and Pastries",
                                  "L_5_Onigiri",
                                  "L_6_Protein sticks",
                                  "L_7_On Route to work",
                                  "L_8_Within 150m",
                                  "L_9_More than 150m",
                                  "L_10_None",
                                  "L_11_Attack on Titan",
                                  "L_12_Doan Ritsu",
                                  "L_13_None",
                                  "L_14_Caffeine or Alertness boost",
                                  "L_15_Natural Mood Stabilizer",
                                  "L_16_None",
                                  "L_17_Loyalty points",
                                  "L_18_Nutrition Advice"))) %>% 
  mutate(group_aggr =
           c("Price", "Price", "Price",
             "Form", "Form", "Form",
             "PurchaseLocation", "PurchaseLocation", "PurchaseLocation",
             "FunPackaging", "FunPackaging", "FunPackaging",
             "CognitiveSupport", "CognitiveSupport","CognitiveSupport",
             "DigitalIntegration", "DigitalIntegration", "DigitalIntegration"
           )) %>% 
  arrange(desc(value))
```


### Trivia (dangerous)



